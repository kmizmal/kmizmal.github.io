<!DOCTYPE html><html lang=zh-CN><head><meta charset=utf-8><title>使用Cloudflare Workers实现Github加速反代 | zmalの折腾笔记</title><meta name=author content=zmal><meta name=description content=总能在平凡的日子里发现无数温暖的惊喜><meta name=keywords content=blog><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=0"><link rel=icon href=/images/avatar.png><link rel=preconnect href=https://s4.zstatic.net><script src=https://s4.zstatic.net/ajax/libs/vue/3.3.7/vue.global.prod.min.js></script><link rel=stylesheet href=https://s4.zstatic.net/ajax/libs/font-awesome/6.4.2/css/all.min.css><link rel=preconnect href=https://fonts.googleapis.cn><link rel=preconnect href=https://fonts.gstatic.cn crossorigin><link rel=stylesheet href="https://fonts.googleapis.cn/css2?family=Fira+Code:wght@400;500;600;700&family=Lexend:wght@400;500;600;700;800;900&family=Noto+Sans+SC:wght@400;500;600;700;800;900&display=swap"><script>let mixins={}</script><script src=/js/jquery-3.7.1.js></script><script src="https://polyfill.alicdn.com/v3/polyfill.min.js?features=default"></script><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.1/highlight.min.js></script><script src=/js/lib/highlight.js></script><link rel=stylesheet href=/css/main.css><style>body{cursor:url(/images/Arrow.ico),auto}</style><script>document.addEventListener("DOMContentLoaded",function(){{var t=window,n=document;let e=n.createElement("div");e.style.cssText="position: fixed; top: 0; left: 0; width: 0; height: 3px;box-shadow: 0 0 3px #999; background: -webkit-linear-gradient(left, red,orange,yellow,green,blue,indigo,violet );z-index: 999999;-webkit-transition:width .3s linear;",n.body.appendChild(e);var i=t.innerHeight||n.documentElement.clientHeight||n.body.clientHeight;t.addEventListener("scroll",function(){e.style.width=Math.round(pageYOffset/(n.body.offsetHeight-i)*100)+"%"},!1)}})</script><meta name=generator content="Hexo 7.3.0"></head><body><div id=layout><transition name=fade><div id=loading v-show=loading><div id=loading-circle><h2>LOADING</h2><p>加载过慢请开启缓存 浏览器默认开启</p><img src=/images/loading.gif></div></div></transition><div id=menu :class="{ hidden: hiddenMenu, 'menu-color': menuColor}"><nav id=desktop-menu><a class=title href=/ ><span>ZMALの折腾笔记</span> </a><a href=/ ><i class="fa-solid fa-house fa-fw"></i> <span>&ensp;Home</span> </a><a href=/about><i class="fa-solid fa-id-card fa-fw"></i> <span>&ensp;About</span> </a><a href=/archives><i class="fa-solid fa-box-archive fa-fw"></i> <span>&ensp;Archives</span> </a><a href=/tags><i class="fa-solid fa-tags fa-fw"></i> <span>&ensp;Tags</span></a></nav><nav id=mobile-menu><div class=title @click="showMenuItems = !showMenuItems"><i class="fa-solid fa-bars fa-fw"></i> <span>&emsp;ZMALの折腾笔记</span></div><transition name=slide><div class=items v-show=showMenuItems><a href=/ ><div class=item><div style=min-width:20px;max-width:50px;width:10%><i class="fa-solid fa-house fa-fw"></i></div><div style=min-width:100px;max-width:150%;width:20%>Home</div></div></a><a href=/about><div class=item><div style=min-width:20px;max-width:50px;width:10%><i class="fa-solid fa-id-card fa-fw"></i></div><div style=min-width:100px;max-width:150%;width:20%>About</div></div></a><a href=/archives><div class=item><div style=min-width:20px;max-width:50px;width:10%><i class="fa-solid fa-box-archive fa-fw"></i></div><div style=min-width:100px;max-width:150%;width:20%>Archives</div></div></a><a href=/tags><div class=item><div style=min-width:20px;max-width:50px;width:10%><i class="fa-solid fa-tags fa-fw"></i></div><div style=min-width:100px;max-width:150%;width:20%>Tags</div></div></a></div></transition></nav></div><transition name=fade><div id=menu-curtain @click="showMenuItems = !showMenuItems" v-show=showMenuItems></div></transition><div id=main :class="loading ? 'into-enter-from': 'into-enter-active'"><div class=article><div><h1>使用Cloudflare Workers实现Github加速反代</h1></div><div class=info><span class=date><span class=icon><i class="fa-solid fa-calendar fa-fw"></i></span> 2025/6/12 <span class=icon><i class="fa-solid fa-wand-magic-sparkles"></i></span> 2025/6/29 </span><span class=tags><span class=icon><i class="fa-solid fa-tags fa-fw"></i> </span><span class=tag><a href=/tags/%E7%AC%94%E8%AE%B0/ style=color:#03a9f4>笔记 </a></span><span class=tag><a href=/tags/%E6%9C%8D%E5%8A%A1/ style=color:#ffa2c4>服务</a></span></span></div><div class=content v-pre><p>虽然cf在国内也会收到gfw的影响，但相对来说比GitHub好好多，故在赛博大善人的workers服务上部署了一个反代服务，主要是给朋友们用及特殊情况应急</p><span id=more></span><p>为避免滥用反代脚本屏蔽了部分敏感路径</p><pre><code>addEventListener(&#39;fetch&#39;, event =&gt; &#123;
  event.respondWith(handleRequest(event))
&#125;)

// 配置常量
const BLOCKED_PATHS = [
  &#39;/login&#39;, &#39;/signup&#39;, &#39;/session&#39;, &#39;/settings&#39;,
  &#39;/oauth&#39;, &#39;/auth&#39;, &#39;/account&#39;, &#39;/user&#39;, &#39;/new&#39;,
  &#39;/marketplace&#39;, &#39;/notifications&#39;
]
const BLOCKED_COOKIES = [&#39;user_session&#39;, &#39;_gh_sess&#39;, &#39;logged_in&#39;]
const CACHE_WHITELIST = [&#39;image&#39;, &#39;font&#39;, &#39;script&#39;, &#39;stylesheet&#39;]
const GIT_PROTOCOL_PATHS = [&#39;/info/refs&#39;, &#39;/git-upload-pack&#39;, &#39;/git-receive-pack&#39;]

async function handleRequest(event) &#123;
  const request = event.request
  const url = new URL(request.url)

  // --- 安全拦截阶段 ---
  if (isBlockedRequest(url)) &#123;
    return createBlockedResponse()
  &#125;

  // --- 请求改写阶段 ---
  const upstreamUrl = buildGitHubUrl(url)
  const newRequest = rewriteRequest(request, upstreamUrl)

  // --- 代理请求阶段 ---
  let response = await fetch(newRequest)

  // --- 响应处理阶段 ---
  return processResponse(response, url.hostname)
&#125;

// 安全检测函数
function isBlockedRequest(url) &#123;
  const path = url.pathname.toLowerCase()
  
  // 拦截登录相关路径
  if (BLOCKED_PATHS.some(p =&gt; path.startsWith(p))) &#123;
    return true
  &#125;

  // 拦截敏感文件请求
  if (path.includes(&#39;/.env&#39;) || path.endsWith(&#39;.php&#39;)) &#123;
    return true
  &#125;

  return false
&#125;

// 构建 GitHub 目标 URL
function buildGitHubUrl(originalUrl) &#123;
  const url = new URL(originalUrl)
  url.hostname = &#39;github.com&#39;
  
  // Git 协议特殊处理
  if (GIT_PROTOCOL_PATHS.some(p =&gt; url.pathname.includes(p))) &#123;
    url.pathname = url.pathname.replace(/\.git(\/|$)/, &#39;$1&#39;)
  &#125;
  
  return url
&#125;

// 请求头改写
function rewriteRequest(originalRequest, upstreamUrl) &#123;
  const headers = new Headers(originalRequest.headers)
  
  // 移除敏感 Cookie
  BLOCKED_COOKIES.forEach(c =&gt; headers.delete(c))
  
  // 修正协议头
  headers.set(&#39;Host&#39;, &#39;github.com&#39;)
  headers.set(&#39;X-Forwarded-Proto&#39;, &#39;https&#39;)
  
  // 构建新请求
  return new Request(upstreamUrl, &#123;
    method: originalRequest.method,
    headers: headers,
    body: originalRequest.body,
    redirect: &#39;manual&#39;
  &#125;)
&#125;

// 响应处理
async function processResponse(response, customHost) &#123;
  const contentType = response.headers.get(&#39;content-type&#39;) || &#39;&#39;
  const isCacheable = CACHE_WHITELIST.some(t =&gt; contentType.includes(t))
  
  // 创建可修改的响应副本
  const newResponse = new Response(response.body, response)

  // 内容重写（仅处理文本内容）
  if (contentType.includes(&#39;text&#39;) || contentType.includes(&#39;json&#39;)) &#123;
    const text = await response.text()
    const replaced = text.replaceAll(&#39;github.com&#39;, customHost)
                         .replaceAll(&#39;www.github.com&#39;, customHost)
    newResponse.headers.set(&#39;content-length&#39;, replaced.length)
    return new Response(replaced, newResponse)
  &#125;

  // 缓存控制
  if (isCacheable &amp;&amp; response.status === 200) &#123;
    newResponse.headers.set(&#39;Cache-Control&#39;, &#39;public, max-age=3600&#39;)
  &#125; else &#123;
    newResponse.headers.set(&#39;Cache-Control&#39;, &#39;no-store&#39;)
  &#125;

  // 处理重定向
  if ([301, 302, 303, 307, 308].includes(response.status)) &#123;
    const location = newResponse.headers.get(&#39;location&#39;)
    if (location &amp;&amp; location.includes(&#39;github.com&#39;)) &#123;
      newResponse.headers.set(&#39;location&#39;, location.replace(&#39;github.com&#39;, customHost))
    &#125;
  &#125;

  // 移除敏感头
  newResponse.headers.delete(&#39;set-cookie&#39;)
  newResponse.headers.delete(&#39;x-github-request-id&#39;)

  return newResponse
&#125;

// 拦截响应生成
function createBlockedResponse() &#123;
  return new Response(&#39;Access Denied&#39;, &#123;
    status: 403,
    headers: &#123;
      &#39;Content-Type&#39;: &#39;text/plain&#39;,
      &#39;Cache-Control&#39;: &#39;no-store&#39;
    &#125;
  &#125;)
&#125;
</code></pre><p>当然你也可以使用我部署好的现成的服务，但是不保证可用，本人不因此反代服务承担任何责任，仅供学习交流使用，严禁滥用！</p><p>使用方法，将任意位置的<code>github.com</code>修改为<code>git.zmal.top</code>(敏感位置不提供反代服务)</p><p>示例</p><blockquote></blockquote><p>原：<code>https://github.com/kmizmal</code><br>使用反代： <code>https://git.zmal.top/kmizmal</code></p><p>原： <code>https://github.com/kmizmal/Sleepy-Android/releases/latest</code><br>使用反代：<code>https://git.zmal.top/kmizmal/Sleepy-Android/releases/latest</code></p><blockquote></blockquote><p><em><strong>注意</strong></em></p><p>该反代脚本会将页面中绝大部分<code>github.com</code>-&gt;<code>git.zmal.top</code><br>如果将来我的反代服务<code>git.zmal.top</code>停止维护请自行替换</p></div></div><footer id=footer><div id=footer-wrap><div>&copy; 2022 - 2025 zmalの折腾笔记 <span id=footer-icon><i class="fa-solid fa-font-awesome fa-fw"></i> </span>&commat;zmal</div><div>Based on the <a target=_blank rel=noopener href=https://hexo.io>Hexo Engine</a> &amp; <a target=_blank rel=noopener href=https://github.com/kmizmal/hexo-theme-particlex>ParticleX Theme</a></div><div>备案号： <a target=_blank rel=noopener href="https://icp.gov.moe/?keyword=20250124">萌ICP备20250124号</a></div><div class=visitors>本站访问次数:<span id=finicount_views></span><script async src=//finicounter.eu.org/finicounter.js></script></div><div><a target=_blank rel=noopener href=https://hoyocard.qhy04.com><img id=game_card src=https://hoyocard.qhy04.com/gs/detail/rand/288292888.png alt=玩原神的这辈子有了></a></div></div></footer></div><script src=/js/TopIndex.js></script><script src=/js/canvas.js></script><transition name=fade><div id=preview ref=preview v-show=previewShow><img id=preview-content ref=previewContent></div></transition></div><script src=/js/main.js></script><script src=/js/span.js></script></body></html>